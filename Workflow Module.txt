# WORKFLOW MODULE - IMPLEMENTATION GUIDE

## Overview
The Workflow Module provides workflow navigation and validation capabilities for process-oriented graphs in NodeBook. It allows users to navigate through connected nodes using "next" edges and validates workflow structure.

---

## Requirements Specification

### Node Type Requirements

#### 1. Start Node
- **Identification:** `name="start"` (case-insensitive)
- **Category:** `category="start-end"`
- **"Next" Edges:** Exactly ONE outgoing "next" edge
- **Other Edges:** Can have multiple "input"/"output" edges

#### 2. End Node
- **Identification:** `name="end"` (case-insensitive)
- **Category:** `category="start-end"`
- **"Next" Edges:** Exactly ONE incoming "next" edge
- **Other Edges:** Can have multiple "input"/"output" edges
- **Constraint:** Must NOT connect back to start node via "next" edge (warning if violated)

#### 3. Task Node
- **Category:** `category="task"`
- **"Next" Edges:** Exactly ONE incoming + ONE outgoing "next" edge
- **Other Edges:** Can have multiple "input"/"output" edges

#### 4. Decision Node
- **Category:** `category="decision"`
- **"Next" Edges:** Exactly ONE incoming + MULTIPLE outgoing "next" edges
- **Other Edges:** Can have multiple "input"/"output" edges
- **Purpose:** Allows workflow branching to multiple paths

### Edge Requirements

#### "Next" Edge Identification
- **Label/Relationship:** `label="next"` OR `relationship="next"` (case-insensitive)
- **Direction:** Must be `directed=true`
- **Flow:** Direction defines workflow flow (source ‚Üí target)

### Validation Rules

#### Blocking Errors (Prevent Navigation)
1. Missing start node
2. Missing end node
3. Task nodes without exactly 1 incoming and 1 outgoing "next" edge
4. Decision nodes without exactly 1 incoming "next" edge
5. Decision nodes without at least 1 outgoing "next" edge
6. Start node without exactly 1 outgoing "next" edge
7. End node without exactly 1 incoming "next" edge

#### Warnings (Allow Navigation)
1. End node connects back to start node
2. Disconnected workflow chains exist
3. Nodes with unrecognized categories in workflow chain

### User Interface Requirements

#### Access Points
1. **Tools Panel:** Button labeled "Workflow" with üîÑ icon
2. **Context Menu:** Right-click on node ‚Üí "Workflow" option

#### Workflow Navigator Modal
- **Modal Behavior:** Blocks graph interaction (focused navigation)
- **Display Elements:**
  - Current node name, category badge, description
  - Position indicator (e.g., "Node 3 of 8 in workflow chain")
  - Input/output connections (non-"next" edges)
  - Validation summary (errors/warnings)
  - Navigation buttons (Previous/Next)
  - Close button
  - "Validation Details" button

#### Navigation Behavior

**Previous Buttons:**
- Single previous node ‚Üí One "Previous" button
- Multiple previous nodes ‚Üí Show first 3 as buttons
- More than 3 ‚Üí Add "... X more ‚ñº" expandable dropdown with remaining nodes

**Next Buttons:**
- Single next node ‚Üí One "Next" button
- Multiple next nodes (decision branching) ‚Üí Show all as separate buttons with labels
  - Format: "Edge Label ‚Üí Node Name"

#### Validation Details Modal
- **Display:**
  - Overall workflow status
  - Start/End node identification
  - Complete error list
  - Complete warning list
  - Disconnected chains with expandable details
- **Features:**
  - List all nodes in each disconnected chain
  - "Highlight on Graph" button for each chain
  - Close button

---

## Implementation Phases

### ‚úÖ Phase 1: Core Workflow Logic (COMPLETED)

**File Created:** `js/workflow.js`

**Components Implemented:**
- `WorkflowManager` class with full functionality
- `findWorkflowChain()` - Discovers all connected nodes via "next" edges
- `validateWorkflowStructure()` - Comprehensive validation with error/warning reporting
- `identifyStartNode()` / `identifyEndNode()` - Node identification
- `validateNodeType()` - Per-node validation
- `findDisconnectedChains()` - Detects other workflow chains
- `getNextNodes()` / `getPreviousNodes()` - Navigation logic
- `navigateToNode()` - Node navigation with history tracking
- `updateNavigatorDisplay()` - UI update methods
- `generatePreviousButtons()` / `generateNextButtons()` - Button generation
- `showValidationDetails()` - Detailed validation modal
- `highlightDisconnectedChain()` - Graph highlighting

**Status:** ‚úÖ Complete and tested

---

### üîÑ Phase 2: Modal HTML Structure (COMPLETED)

**File to Modify:** `index.html`

**Location:** Before closing `</body>` tag

**What to Add:**

#### 1. Workflow Navigator Modal
```html
<!-- Workflow Navigator Modal -->
<div id="workflow-modal" class="modal hidden">
    <div class="modal-content workflow-modal-content">
        <div class="modal-header">
            <h2>Workflow Navigator</h2>
            <button class="modal-close" id="workflow-close">&times;</button>
        </div>
        
        <!-- Validation Summary Section -->
        <div id="workflow-validation-summary" class="workflow-validation">
            <!-- Status, warnings, errors will be inserted here dynamically -->
        </div>
        
        <div class="modal-body">
            <!-- Current Node Display -->
            <div class="workflow-current-node">
                <h3 id="workflow-node-name">Node Name</h3>
                <p id="workflow-node-category" class="workflow-category-badge"></p>
                <p id="workflow-node-description"></p>
            </div>
            
            <!-- Position Indicator -->
            <div id="workflow-position" class="workflow-position">
                <!-- e.g., "Node 3 of 8 in workflow chain" -->
            </div>
            
            <!-- Inputs/Outputs -->
            <div class="workflow-connections">
                <div class="workflow-inputs">
                    <h4>Inputs</h4>
                    <ul id="workflow-inputs-list"></ul>
                </div>
                <div class="workflow-outputs">
                    <h4>Outputs</h4>
                    <ul id="workflow-outputs-list"></ul>
                </div>
            </div>
        </div>
        
        <div class="modal-footer workflow-navigation">
            <!-- Previous buttons (dynamically generated) -->
            <div id="workflow-prev-buttons" class="workflow-nav-group"></div>
            
            <!-- Next buttons (dynamically generated) -->
            <div id="workflow-next-buttons" class="workflow-nav-group"></div>
            
            <button class="btn btn-secondary" id="workflow-close-btn">Close</button>
            <button class="btn btn-secondary" id="workflow-validation-details">Validation Details</button>
        </div>
    </div>
</div>
```

#### 2. Validation Details Modal
```html
<!-- Validation Details Modal -->
<div id="workflow-validation-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Workflow Validation Report</h2>
            <button class="modal-close" id="validation-close">&times;</button>
        </div>
        <div class="modal-body" id="validation-details-body">
            <!-- Detailed validation report inserted dynamically -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="validation-close-btn">Close</button>
        </div>
    </div>
</div>
```

---

### üîÑ Phase 3: Styling (NEXT)

**File to Create:** `styles/workflow.css`

**Sections to Style:**

#### 1. Modal Layout
- `.workflow-modal-content` - Modal dimensions (800px width, max-height 90vh)
- Responsive design for mobile devices

#### 2. Validation Display
- `.workflow-validation` - Container styling
- `.workflow-validation-errors` - Red color scheme for errors
- `.workflow-validation-warnings` - Yellow/orange color scheme for warnings
- `.workflow-validation-success` - Green color scheme for success

#### 3. Current Node Display
- `.workflow-current-node` - Card-style display
- `.workflow-category-badge` - Colored badges for node types
  - `.workflow-category-start-end` - Blue
  - `.workflow-category-task` - Green
  - `.workflow-category-decision` - Orange
  - `.workflow-category-unknown` - Gray

#### 4. Position Indicator
- `.workflow-position` - Progress/position display styling

#### 5. Connections Display
- `.workflow-connections` - Two-column layout
- `.workflow-inputs` / `.workflow-outputs` - Column styling
- `.workflow-no-connections` - Muted text for empty states

#### 6. Navigation Buttons
- `.workflow-navigation` - Footer button layout
- `.workflow-nav-group` - Button grouping
- `.workflow-nav-btn` - Individual navigation button styling
- `.workflow-dropdown-container` - Expandable dropdown container
- `.workflow-dropdown-toggle` - Toggle button for "... X more"
- `.workflow-dropdown-list` - Dropdown list styling
- `.workflow-dropdown-item` - Individual dropdown item

#### 7. Validation Details
- `.validation-section` - Section dividers
- `.validation-error-list` / `.validation-warning-list` - List styling
- `.disconnected-chain` - Chain card display
- `.workflow-highlight-chain` - Highlight button styling

#### 8. Responsive Design
- Mobile breakpoints
- Scrollable content areas
- Touch-friendly button sizes

---

### üîÑ Phase 4: Tools Panel Integration (NEXT)

**File to Modify:** `index.html`

**Location:** Inside `<div id="tools-tab" class="tab-panel">`, after the "Path" button

**What to Add:**
```html
<button id="btn-workflow" class="tool-btn" title="Workflow Navigator">
    <span>üîÑ</span>
    <span class="tool-label">Workflow</span>
</button>
```

**Exact Position:**
- After: `<button id="btn-shortest-path" ...>`
- Before: `<div class="tool-separator"></div>` (if one exists) or before `<button id="btn-add-graph" ...>`

---

### üîÑ Phase 5: Context Menu Integration (NEXT)

**File to Modify:** `js/contextMenu.js`

**Location:** Inside `showNodeMenu(node, event)` method

**What to Add:**
After the "Connect by Click" menu item (around line 50-70), add:

```javascript
{
    icon: 'üîÑ',
    label: 'Workflow',
    action: () => this.app.workflowManager.openWorkflowNavigator(node.id)
},
```

**Exact Context:**
```javascript
{
    icon: '‚Üí',
    label: 'Connect by Click',
    action: () => this.startConnectByClick(node)
},
{ separator: true },  // <-- This separator might already exist
{
    icon: 'üîÑ',
    label: 'Workflow',
    action: () => this.app.workflowManager.openWorkflowNavigator(node.id)
},
{ separator: true },
{
    icon: 'üóëÔ∏è',
    label: 'Delete Node',
    className: 'danger',
    action: () => this.deleteNode(node)
}
```

---

### üîÑ Phase 6: App Integration (NEXT)

**File to Modify:** `js/app.js`

#### 1. Initialize WorkflowManager in Constructor
**Location:** In the `constructor()` method, after other manager initializations

**What to Add:**
```javascript
// Initialize workflow manager
this.workflowManager = new WorkflowManager(this);
```

**Exact Context:**
```javascript
// Initialize context menu
this.contextMenu = new ContextMenuManager(this);

// Initialize workflow manager
this.workflowManager = new WorkflowManager(this);
```

#### 2. Add Event Listener
**Location:** In `setupEventListeners()` method, after the shortest path button listener

**What to Add:**
```javascript
// Workflow button
document.getElementById('btn-workflow')?.addEventListener('click', () => {
    if (this.renderer.selectedNodes.length === 1) {
        const nodeId = this.renderer.selectedNodes[0];
        this.workflowManager.openWorkflowNavigator(nodeId);
    } else {
        this.updateStatus('Please select a single node first');
    }
});
```

**Exact Context:**
```javascript
document.getElementById('btn-shortest-path')?.addEventListener('click', () => this.startShortestPath());

// Workflow button
document.getElementById('btn-workflow')?.addEventListener('click', () => {
    if (this.renderer.selectedNodes.length === 1) {
        const nodeId = this.renderer.selectedNodes[0];
        this.workflowManager.openWorkflowNavigator(nodeId);
    } else {
        this.updateStatus('Please select a single node first');
    }
});

document.getElementById('btn-add-graph')?.addEventListener('click', () => this.addGraphFromFile());
```

#### 3. Add Script Tag
**File to Modify:** `index.html`

**Location:** In the `<head>` section or before closing `</body>` tag, with other script tags

**What to Add:**
```html
<script src="js/workflow.js"></script>
```

**Exact Context (Before closing `</body>`):**
```html
<script src="js/contextMenu.js"></script>
<script src="js/workflow.js"></script>
<script src="js/app.js"></script>
</body>
```

---

### üîÑ Phase 7: Testing & Refinement (FINAL)

**Test Scenarios:**

1. **Valid Linear Workflow**
   - Create: start ‚Üí task1 ‚Üí task2 ‚Üí end
   - Test: Navigation forward/backward
   - Expected: All navigation works, no errors

2. **Workflow with Decision**
   - Create: start ‚Üí task1 ‚Üí decision ‚Üí [task2, task3] ‚Üí end
   - Test: Multiple "Next" buttons from decision
   - Expected: Two next buttons with labels

3. **Workflow with Merge Point**
   - Create: start ‚Üí decision ‚Üí [task1, task2] ‚Üí task3 ‚Üí end
   - Test: Multiple "Previous" buttons at task3
   - Expected: First 3 shown, expandable if more

4. **Workflow with Loop**
   - Create: start ‚Üí task1 ‚Üí decision ‚Üí [task2 (back to task1), task3] ‚Üí end
   - Test: Navigation through loop
   - Expected: Works correctly, no infinite loop issues

5. **End‚ÜíStart Connection (Warning)**
   - Create valid workflow, then add: end ‚Üí start
   - Test: Open workflow navigator
   - Expected: Warning displayed, navigation still works

6. **Missing Start Node (Error)**
   - Create: task1 ‚Üí task2 ‚Üí end (no start)
   - Test: Open workflow navigator
   - Expected: Error message, blocked navigation

7. **Missing End Node (Error)**
   - Create: start ‚Üí task1 ‚Üí task2 (no end)
   - Test: Open workflow navigator
   - Expected: Error message, blocked navigation

8. **Disconnected Chains**
   - Create two separate workflows: Chain A (complete), Chain B (incomplete)
   - Test: Open workflow on Chain A
   - Expected: Warning about Chain B, list nodes, highlight button works

9. **Non-Workflow Node**
   - Create node with no "next" edges
   - Test: Click "Workflow" on that node
   - Expected: Clear error message

10. **More than 3 Previous Nodes**
    - Create 5 nodes all connecting to 1 node
    - Test: Navigate to the converging node
    - Expected: 3 buttons + "... 2 more" dropdown

---

## Integration Checklist

### Files to Create
- [x] `js/workflow.js` - **COMPLETED**
- [ ] `styles/workflow.css`

### Files to Modify
- [ ] `index.html` (3 locations):
  - [ ] Add workflow button in Tools tab
  - [ ] Add workflow navigator modal HTML
  - [ ] Add validation details modal HTML
  - [ ] Add script tag for workflow.js
- [ ] `js/contextMenu.js` (1 location):
  - [ ] Add "Workflow" option in node context menu
- [ ] `js/app.js` (2 locations):
  - [ ] Initialize WorkflowManager in constructor
  - [ ] Add event listener for workflow button

---

## File Locations Reference

### `index.html` Modifications

**Location 1: Tools Panel Button**
- **Section:** `<div id="tools-tab" class="tab-panel">`
- **After element:** `<button id="btn-shortest-path" ...>`
- **Insert:** Workflow button

**Location 2: Modals**
- **Section:** Before closing `</body>` tag
- **After element:** Last modal in document (possibly filter modal or other modals)
- **Insert:** Both workflow modals

**Location 3: Script Tag**
- **Section:** Before closing `</body>` tag in script section
- **After element:** `<script src="js/contextMenu.js"></script>`
- **Before element:** `<script src="js/app.js"></script>`
- **Insert:** Workflow script tag

### `js/contextMenu.js` Modification

**Method:** `showNodeMenu(node, event)`
- **After block:** "Connect by Click" menu item
- **Before block:** Delete Node menu item (or separator before it)
- **Insert:** Workflow menu item

### `js/app.js` Modifications

**Location 1: Constructor**
- **After line:** `this.contextMenu = new ContextMenuManager(this);`
- **Insert:** WorkflowManager initialization

**Location 2: setupEventListeners Method**
- **After block:** `btn-shortest-path` event listener
- **Before block:** `btn-add-graph` event listener
- **Insert:** Workflow button event listener

---

## Notes for Implementation

1. **Order Matters:** Complete phases in sequence as later phases depend on earlier ones
2. **CSS First:** Consider completing Phase 3 (styling) before Phase 2 (HTML) if you want to see styled output immediately
3. **Testing:** Test after each phase to catch issues early
4. **Case Sensitivity:** Remember all "next" and "start"/"end" matching is case-insensitive
5. **Sample Graph:** Use `AS9100AuditChecklist_flow.json` as test data (has workflow-like structure)
6. **Backward Compatibility:** Implementation doesn't affect existing graph functionality

---

## Quick Start for Next Session

1. Upload this document to project knowledge
2. Reference: "Continue Workflow Module implementation - Phase 2"
3. Current Status: Phase 1 complete (workflow.js created)
4. Next Task: Create workflow.css or add HTML modals to index.html

---

## Current Implementation Status

- ‚úÖ Phase 1: Core Logic (workflow.js) - **COMPLETE**
- ‚è≥ Phase 2: Modal HTML - **PENDING**
- ‚è≥ Phase 3: Styling (workflow.css) - **PENDING**
- ‚è≥ Phase 4: Tools Panel Integration - **PENDING**
- ‚è≥ Phase 5: Context Menu Integration - **PENDING**
- ‚è≥ Phase 6: App Integration - **PENDING**
- ‚è≥ Phase 7: Testing - **PENDING**

**Next Action:** Proceed with Phase 2 or Phase 3

---

## Support & Questions

If any issues arise during implementation:
1. Verify `workflow.js` is properly loaded in browser console
2. Check browser console for JavaScript errors
3. Verify modal HTML IDs match those referenced in workflow.js
4. Ensure CSS classes are properly defined
5. Test with a simple workflow first (start ‚Üí task ‚Üí end)

---

**Document Version:** 1.0  
**Date Created:** 2025-01-29  
**Phase 1 Completion Date:** 2025-01-29  
**Status:** Ready for Phase 2